---
layout: oneColumn
loadAudioPlayer: true
---

<!-- Audio player card -->
<div class="bg-slate-50 rounded-2xl p-4 md:p-6 shadow-sm border border-slate-100 mb-8">
    <div class="flex flex-col md:flex-row gap-4 md:gap-6">
        <!-- Cover art -->
        <div id="cover-image" class="shrink-0 mx-auto md:mx-0">
            <img
                data-amplitude-song-info="cover_art_url"
                title="{{title}}"
                alt="{%- if media.title -%}{{media.title}}{%- else -%}DJ Cruze Audio{%- endif -%}"
                class="rounded-lg aspect-square object-cover shadow-md w-48 md:w-40"
            />
        </div>

        <!-- Player content -->
        <div class="flex-1 min-w-0 flex flex-col justify-center gap-3">
            <!-- Track info -->
            <div id="audio-metadata">
                <div
                    data-amplitude-song-info="artist"
                    class="text-lg font-bold uppercase leading-tight"
                ></div>
                <div
                    data-amplitude-song-info="name"
                    class="text-base font-semibold uppercase leading-tight"
                ></div>
                <div class="text-xs {{theme.main.secondary}} font-medium uppercase pt-1">
                    {{page.date | pageDate}}
                </div>
            </div>

            <!-- Player controls + progress bar -->
            <div id="audio-progress-bar">
                <div class="flex items-center gap-3">
                    <div id="audio-buttons" class="shrink-0">
                        <div
                            class="cursor-pointer text-slate-800"
                            id="playButton"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                viewBox="0 0 512 512"
                                class="w-10 h-10 fill-current {{theme.audioPlayer.controls.hover}}"
                            >
                                <!--! Font Awesome Pro 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. -->
                                <path
                                    d="M512 256c0 141.4-114.6 256-256 256S0 397.4 0 256S114.6 0 256 0S512 114.6 512 256zM188.3 147.1c-7.6 4.2-12.3 12.3-12.3 20.9V344c0 8.7 4.7 16.7 12.3 20.9s16.8 4.1 24.3-.5l144-88c7.1-4.4 11.5-12.1 11.5-20.5s-4.4-16.1-11.5-20.5l-144-88c-7.4-4.5-16.7-4.7-24.3-.5z"
                                />
                            </svg>
                        </div>
                        <div
                            class="hidden cursor-pointer"
                            id="pauseButton"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                viewBox="0 0 512 512"
                                class="w-10 h-10 fill-current {{theme.audioPlayer.controls.hover}}"
                            >
                                <!--! Font Awesome Pro 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. -->
                                <path
                                    d="M256 512c141.4 0 256-114.6 256-256S397.4 0 256 0S0 114.6 0 256S114.6 512 256 512zM224 192V320c0 17.7-14.3 32-32 32s-32-14.3-32-32V192c0-17.7 14.3-32 32-32s32 14.3 32 32zm128 0V320c0 17.7-14.3 32-32 32s-32-14.3-32-32V192c0-17.7 14.3-32 32-32s32 14.3 32 32z"
                                />
                            </svg>
                        </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <progress
                            class="amplitude-song-played-progress"
                            id="song-played-progress"
                        ></progress>
                        <div class="text-xs {{theme.main.secondary}} font-medium text-right font-mono pt-1">
                            <span class="amplitude-current-time"></span> /
                            <span class="amplitude-duration-time"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions: download + subscribe -->
            <div class="flex items-center gap-4 flex-wrap">
                {% if download %}
                <a
                    href="{{site.mediaFilesUrl}}{{media.content}}"
                    title="{{media.title}}"
                    download
                    class="inline-flex items-center {{theme.audioPlayer.downloadButton}} font-semibold py-1.5 px-3 rounded-lg transition-all duration-300 hover:scale-[1.02] space-x-1.5 uppercase text-xs"
                >
                    <svg
                        class="w-3.5 h-3.5"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                        />
                    </svg>
                    <span>Download</span>
                </a>
                {% endif %}

                {% if subscribe %}
                <div class="flex items-center gap-2">
                    <span class="text-xs font-medium uppercase {{theme.main.secondary}}">Subscribe</span>
                    {% for podcastItem in podcast.links %}
                    <a
                        href="{{podcastItem.url}}"
                        target="_blank"
                        rel="noopener"
                        title="{{podcastItem.name}}"
                        class="block transition-transform duration-150 hover:scale-110"
                    ><img
                        src="{{podcastItem.icon}}"
                        class="w-6 h-6 rounded-sm"
                        alt="Subscribe with {{podcastItem.name}}"
                    /></a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if media.tracklist %}
{% assign jsonTracklist = media.tracklist | tracklistToJson %}
<div class="pt-6 pb-2">
    <h3 class="text-xl md:text-2xl font-extrabold text-left uppercase pb-4">Tracklist</h3>
    <ol id="tracklist" class="space-y-0">
        {% for track in jsonTracklist.tracklist %}
        <li
            class="tracklist-row flex items-baseline gap-3 py-2 px-3 rounded-lg {{theme.audioPlayer.tracklist.hover}} transition-colors duration-150{% if track.timestampInSeconds != null %} cursor-pointer{% endif %}"
            {% if track.timestampInSeconds != null %}data-timestamp="{{track.timestampInSeconds}}"{% endif %}
        >
            <span class="tracklist-number text-sm font-bold {{theme.main.secondary}} w-6 text-right shrink-0">
                {{forloop.index}}
            </span>
            <div class="flex-1 min-w-0">
                <span class="font-semibold uppercase text-base md:text-lg">{{track.artist}}</span>
                {% if track.title %}
                <span class="uppercase text-base md:text-lg"> - {{track.title}}</span>
                {% endif %}
                {% if jsonTracklist.hasLabels and track.label %}
                <span class="hidden md:inline text-sm {{theme.main.secondary}}"> [{{track.label}}]</span>
                {% endif %}
            </div>
            {% if track.timestampInSeconds != null %}
            <span class="tracklist-timestamp text-sm {{theme.main.secondary}} shrink-0 font-mono">
                {{track.timestamp | replace: "[", "" | replace: "]", ""}}
            </span>
            {% endif %}
        </li>
        {% endfor %}
    </ol>
</div>
{% endif %}

{% if content != blank %}
<div class="border-t border-slate-200 mt-8 pt-8">
    <div class="prose prose-lg mx-auto">{{content}}</div>
</div>
{% endif %}

<script>
    let isPlaying = false;
    const playButton = document.getElementById('playButton');
    const pauseButton = document.getElementById('pauseButton');

    const showAudioButtons = (playing = true) => {
      playButton.classList.toggle('hidden');
      pauseButton.classList.toggle('hidden');
    };

    const audioFinishedPlaying = () => {
      isPlaying = false;
      showAudioButtons(isPlaying);
    };

    // Active track highlighting setup (must be before Amplitude.init)
    const ACTIVE_TRACK_CLASS = 'tracklist-row-active';
    const tracklistElement = document.getElementById('tracklist');
    let trackTimestamps = [];

    if (tracklistElement) {
        const tracklistRowsWithTimestamps = tracklistElement.querySelectorAll('.tracklist-row[data-timestamp]');
        trackTimestamps = Array.from(tracklistRowsWithTimestamps).map((row) => ({
            element: row,
            timestampInSeconds: parseInt(row.dataset.timestamp, 10),
        })).filter((track) => !isNaN(track.timestampInSeconds))
          .sort((trackA, trackB) => trackA.timestampInSeconds - trackB.timestampInSeconds);
    }

    const highlightActiveTrack = () => {
        if (trackTimestamps.length === 0) return;

        const currentTimeInSeconds = Amplitude.getSongPlayedSeconds();
        let activeTrackIndex = -1;

        // Find the last track whose timestamp is at or before the current time
        for (let index = trackTimestamps.length - 1; index >= 0; index--) {
            if (trackTimestamps[index].timestampInSeconds <= currentTimeInSeconds) {
                activeTrackIndex = index;
                break;
            }
        }

        trackTimestamps.forEach((track, index) => {
            if (index === activeTrackIndex) {
                track.element.classList.add(ACTIVE_TRACK_CLASS);
            } else {
                track.element.classList.remove(ACTIVE_TRACK_CLASS);
            }
        });
    };

    const clearActiveTrackHighlighting = () => {
        trackTimestamps.forEach((track) => {
            track.element.classList.remove(ACTIVE_TRACK_CLASS);
        });
    };

    // Polling fallback for active track highlighting
    const HIGHLIGHT_UPDATE_INTERVAL_MILLISECONDS = 1000;
    let highlightingIntervalId = null;

    const startHighlightPolling = () => {
        if (!highlightingIntervalId && trackTimestamps.length > 0) {
            highlightingIntervalId = setInterval(highlightActiveTrack, HIGHLIGHT_UPDATE_INTERVAL_MILLISECONDS);
        }
    };

    const stopHighlightPolling = () => {
        if (highlightingIntervalId) {
            clearInterval(highlightingIntervalId);
            highlightingIntervalId = null;
        }
        clearActiveTrackHighlighting();
    };

    {% if media.title %}
    const mediaTitle = '{{media.title}}';
    {% else %}
    const mediaTitle = null;
    {% endif %}
    const mediaAuthor = '{{media.author}}';
    const mediaImage = '{{media.image}}';
    const options = {
      songs: [
        {
          name: mediaTitle || '{{title | escape}}',
          artist: mediaAuthor || 'DJ Cruze',
          url: '{{site.mediaFilesUrl}}{{media.content}}',
          cover_art_url: mediaImage || '/images/mixes/dj-cruze-mix-logo-600x600.jpg',
        },
      ],
      callbacks: {
        stop: () => {
            audioFinishedPlaying();
            stopHighlightPolling();
        },
        timeupdate: () => {
            highlightActiveTrack();
        },
      },
      waveforms: {
        sample_rate: 200,
      }
    };
    Amplitude.init(options);

    // Handle a click on the song played progress bar.
    const progressBarElement = document.getElementById('song-played-progress');

    const setProgressBar = (event) => {
      const offset = progressBarElement.getBoundingClientRect();
        const offsetWidth = progressBarElement.offsetWidth;
        const x = event.pageX - offset.left;

        Amplitude.setSongPlayedPercentage(
          (parseFloat(x) / parseFloat(offsetWidth)) * 100
        );
    };

    ['click', 'touchend'].forEach((event) => {
      progressBarElement.addEventListener(event, setProgressBar);
    });

    const togglePlaying = () =>{
      if (!isPlaying) {
        Amplitude.play();
        isPlaying = true;
        startHighlightPolling();
      } else {
        Amplitude.pause();
        isPlaying = false;
        stopHighlightPolling();
      }
      showAudioButtons(isPlaying);
    };

    playButton.addEventListener('click', togglePlaying);
    pauseButton.addEventListener('click', togglePlaying);

    // Click-to-seek on tracklist rows with timestamps
    if (tracklistElement) {
        const seekableRows = tracklistElement.querySelectorAll('.tracklist-row[data-timestamp]');

        const seekToTrackTimestamp = (event) => {
            const clickedRow = event.currentTarget;
            const timestampInSeconds = parseInt(clickedRow.dataset.timestamp, 10);

            if (isNaN(timestampInSeconds)) return;

            // Calculate percentage of total duration and seek
            const songDurationInSeconds = Amplitude.getSongDuration();
            if (songDurationInSeconds > 0) {
                const seekPercentage = (timestampInSeconds / songDurationInSeconds) * 100;
                Amplitude.setSongPlayedPercentage(seekPercentage);
            }
        };

        seekableRows.forEach((row) => {
            row.addEventListener('click', seekToTrackTimestamp);
        });
    }
</script>
